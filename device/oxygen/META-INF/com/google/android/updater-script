getprop("ro.product.device") == "oxygen" || abort("E3004: This package is for \"oxygen\" devices; this is a \"" + getprop("ro.product.device") + "\".");
show_progress(0.100000, 5);
mount("ext4", "EMMC", "/dev/block/bootdevice/by-name/cust", "/cust", "max_batch_time=0,commit=1,data=ordered,barrier=1,errors=panic,nodelalloc");
delete_recursive("/cust");
package_extract_dir("cust", "/cust") || abort("Failed to extract dir from \"cust\" to \"/cust\".");
set_metadata_recursive("/cust", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0644, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
show_progress(0.200000, 10);
package_extract_file("boot.img", "/dev/block/bootdevice/by-name/boot");

# ---- radio update tasks ----

ui_print("Patching firmware images...");
package_extract_file("firmware-update/cmnlib64.mbn", "/dev/block/bootdevice/by-name/cmnlib64");
package_extract_file("firmware-update/cmnlib.mbn", "/dev/block/bootdevice/by-name/cmnlib");
package_extract_file("firmware-update/rpm.mbn", "/dev/block/bootdevice/by-name/rpm");
package_extract_file("firmware-update/tz.mbn", "/dev/block/bootdevice/by-name/tz");
package_extract_file("firmware-update/emmc_appsboot.mbn", "/dev/block/bootdevice/by-name/aboot");
package_extract_file("firmware-update/lksecapp.mbn", "/dev/block/bootdevice/by-name/lksecapp");
package_extract_file("firmware-update/sbl1.mbn", "/dev/block/bootdevice/by-name/sbl1");
package_extract_file("firmware-update/devcfg.mbn", "/dev/block/bootdevice/by-name/devcfg");
package_extract_file("firmware-update/keymaster.mbn", "/dev/block/bootdevice/by-name/keymaster");
package_extract_file("firmware-update/cmnlib64.mbn", "/dev/block/bootdevice/by-name/cmnlib64bak");
package_extract_file("firmware-update/cmnlib.mbn", "/dev/block/bootdevice/by-name/cmnlibbak");
package_extract_file("firmware-update/rpm.mbn", "/dev/block/bootdevice/by-name/rpmbak");
package_extract_file("firmware-update/tz.mbn", "/dev/block/bootdevice/by-name/tzbak");
package_extract_file("firmware-update/emmc_appsboot.mbn", "/dev/block/bootdevice/by-name/abootbak");
package_extract_file("firmware-update/lksecapp.mbn", "/dev/block/bootdevice/by-name/lksecappbak");
package_extract_file("firmware-update/sbl1.mbn", "/dev/block/bootdevice/by-name/sbl1bak");
package_extract_file("firmware-update/devcfg.mbn", "/dev/block/bootdevice/by-name/devcfgbak");
package_extract_file("firmware-update/keymaster.mbn", "/dev/block/bootdevice/by-name/keymasterbak");
package_extract_file("firmware-update/splash.img", "/dev/block/bootdevice/by-name/splash");
package_extract_file("firmware-update/NON-HLOS.bin", "/dev/block/bootdevice/by-name/modem");
package_extract_file("firmware-update/logo.img", "/dev/block/bootdevice/by-name/logo");
package_extract_file("firmware-update/adspso.bin", "/dev/block/bootdevice/by-name/dsp");
package_extract_file("META-INF/com/miui/miui_update", "/cache/miui_update");
set_metadata("/cache/miui_update", "uid", 0, "gid", 0, "mode", 0555, "capabilities", 0x0);
run_program("/cache/miui_update");
delete("/cache/miui_update");
show_progress(0.600000, 250);
ui_print("Installing MIUI update...");
block_image_update("/dev/block/bootdevice/by-name/system", package_extract_file("system.transfer.list"), "system.new.dat", "system.patch.dat") ||
  abort("E1001: Failed to update system image.");
show_progress(0.100000, 2);
unmount("/cust");
delete_recursive("/data/app/3rd-cn.wps.moffice_eng");
delete_recursive("/cust/app/customized/3rd-cn.wps.moffice_eng");
delete_recursive("/data/app/3rd-com.cleanmaster.mguard_cn");
delete_recursive("/cust/app/customized/3rd-com.cleanmaster.mguard_cn");
delete_recursive("/data/app/3rd-com.dianping.v1");
delete_recursive("/cust/app/customized/3rd-com.dianping.v1");
delete_recursive("/data/app/3rd-com.duokan.reader");
delete_recursive("/cust/app/customized/3rd-com.duokan.reader");
delete_recursive("/data/app/3rd-com.Qunar");
delete_recursive("/cust/app/customized/3rd-com.Qunar");
delete_recursive("/data/app/3rd-com.sdu.didi.psnger");
delete_recursive("/cust/app/customized/3rd-com.sdu.didi.psnger");
delete_recursive("/data/app/3rd-com.sina.weibo");
delete_recursive("/cust/app/customized/3rd-com.sina.weibo");
delete_recursive("/data/app/3rd-com.ss.android.article.news");
delete_recursive("/cust/app/customized/3rd-com.ss.android.article.news");
delete_recursive("/data/app/3rd-com.tencent.mobileqq");
delete_recursive("/cust/app/customized/3rd-com.tencent.mobileqq");
delete_recursive("/data/app/3rd-com.tencent.mobileqq");
delete_recursive("/cust/app/customized/3rd-com.tencent.mobileqq");
delete_recursive("/data/app/3rd-com.tencent.qqmusic");
delete_recursive("/cust/app/customized/3rd-com.tencent.qqmusic");
delete_recursive("/data/app/3rd-com.yiche.price");
delete_recursive("/cust/app/customized/3rd-com.yiche.price");
delete_recursive("/data/app/3rd-com.zhangdan.app");
delete_recursive("/cust/app/customized/3rd-com.zhangdan.app");
delete_recursive("/data/app/3rd-ctrip.android.view");
delete_recursive("/cust/app/customized/3rd-ctrip.android.view");
delete_recursive("/data/app/3rd-Didi");
delete_recursive("/cust/app/customized/3rd-Didi");
delete_recursive("/data/app/3rd-DkReader");
delete_recursive("/cust/app/customized/3rd-DkReader");
delete_recursive("/data/app/3rd-mOffice");
delete_recursive("/cust/app/customized/3rd-mOffice");
delete_recursive("/data/app/3rd-QQ");
delete_recursive("/cust/app/customized/3rd-QQ");
delete_recursive("/data/app/3rd-Qunar");
delete_recursive("/cust/app/customized/3rd-Qunar");
delete_recursive("/data/app/3rd-Weibo");
delete_recursive("/cust/app/customized/3rd-Weibo");
delete_recursive("/data/app/AdEcommerce");
delete_recursive("/cust/app/customized/AdEcommerce");
delete_recursive("/data/app/com.alipay.android.app-1");
delete_recursive("/cust/app/customized/com.alipay.android.app-1");
delete_recursive("/data/app/com.baidu.BaiduMap-1");
delete_recursive("/cust/app/customized/com.baidu.BaiduMap-1");
delete_recursive("/data/app/com.baidu.input_mi-1");
delete_recursive("/cust/app/customized/com.baidu.input_mi-1");
delete_recursive("/data/app/com.cleanmaster.mguard_cn-1");
delete_recursive("/cust/app/customized/com.cleanmaster.mguard_cn-1");
delete_recursive("/data/app/com.dianping.v1-1");
delete_recursive("/cust/app/customized/com.dianping.v1-1");
delete_recursive("/data/app/com.duokan.reader-1");
delete_recursive("/cust/app/customized/com.duokan.reader-1");
delete_recursive("/data/app/com.miui.klo.bugreport");
delete_recursive("/cust/app/customized/com.miui.klo.bugreport");
delete_recursive("/data/app/com.miui.transfer-1");
delete_recursive("/cust/app/customized/com.miui.transfer-1");
delete_recursive("/data/app/com.miui.transfer");
delete_recursive("/cust/app/customized/com.miui.transfer");
delete_recursive("/data/app/com.Quanar-1");
delete_recursive("/cust/app/customized/com.Quanar-1");
delete_recursive("/data/app/com.sdu.didi.psnger-1");
delete_recursive("/cust/app/customized/com.sdu.didi.psnger-1");
delete_recursive("/data/app/com.sina.weibo-1");
delete_recursive("/cust/app/customized/com.sina.weibo-1");
delete_recursive("/data/app/com.xiaomi.channel-1");
delete_recursive("/cust/app/customized/com.xiaomi.channel-1");
delete_recursive("/data/app/com.xiaomi.o2o-1");
delete_recursive("/cust/app/customized/com.xiaomi.o2o-1");
delete_recursive("/data/app/com.xiaomi.o2o-2");
delete_recursive("/cust/app/customized/com.xiaomi.o2o-2");
delete_recursive("/data/app/com.xiaomi.o2o");
delete_recursive("/cust/app/customized/com.xiaomi.o2o");
delete_recursive("/data/app/com.xiaomi.shop-1");
delete_recursive("/cust/app/customized/com.xiaomi.shop-1");
delete_recursive("/data/app/com.yidian.xiaomi-1");
delete_recursive("/cust/app/customized/com.yidian.xiaomi-1");
delete_recursive("/data/app/com.yidian.xiaomi");
delete_recursive("/cust/app/customized/com.yidian.xiaomi");
delete_recursive("/data/app/klobugreport");
delete_recursive("/cust/app/customized/klobugreport");
delete_recursive("/data/app/MiFinance");
delete_recursive("/cust/app/customized/MiFinance");
delete_recursive("/data/app/MiFinance");
delete_recursive("/cust/app/customized/MiFinance");
delete_recursive("/data/app/MiuiBBS");
delete_recursive("/cust/app/customized/MiuiBBS");
delete_recursive("/data/app/O2O");
delete_recursive("/cust/app/customized/O2O");
delete_recursive("/data/app/ota-miui-MiShop");
delete_recursive("/cust/app/customized/ota-miui-MiShop");
delete_recursive("/data/app/ota-miui-vtalk");
delete_recursive("/cust/app/customized/ota-miui-vtalk");
delete_recursive("/data/app/ota-miui-XiaomiSmartHome");
delete_recursive("/cust/app/customized/ota-miui-XiaomiSmartHome");
delete_recursive("/data/app/ota-partner-MU");
delete_recursive("/cust/app/customized/ota-partner-MU");
delete_recursive("/data/app/ota-partner-NetworkAssistant");
delete_recursive("/cust/app/customized/ota-partner-NetworkAssistant");
delete_recursive("/data/app/ota-partner-Zixun");
delete_recursive("/cust/app/customized/ota-partner-Zixun");
delete_recursive("/data/app/partner-58Client");
delete_recursive("/cust/app/customized/partner-58Client");
delete_recursive("/data/app/partner-Alipay");
delete_recursive("/cust/app/customized/partner-Alipay");
delete_recursive("/data/app/partner-AlipayMsp");
delete_recursive("/cust/app/customized/partner-AlipayMsp");
delete_recursive("/data/app/partner-AMAP");
delete_recursive("/cust/app/customized/partner-AMAP");
delete_recursive("/data/app/partner-AMAP");
delete_recursive("/cust/app/customized/partner-AMAP");
delete_recursive("/data/app/partner-Amazon");
delete_recursive("/cust/app/customized/partner-Amazon");
delete_recursive("/data/app/partner-BaiduIME");
delete_recursive("/cust/app/customized/partner-BaiduIME");
delete_recursive("/data/app/partner-BaiduIME");
delete_recursive("/cust/app/customized/partner-BaiduIME");
delete_recursive("/data/app/partner-BaiduMap");
delete_recursive("/cust/app/customized/partner-BaiduMap");
delete_recursive("/data/app/partner-BaiduTieba");
delete_recursive("/cust/app/customized/partner-BaiduTieba");
delete_recursive("/data/app/partner-CleanMaster");
delete_recursive("/cust/app/customized/partner-CleanMaster");
delete_recursive("/data/app/partner-com.duokan.reader");
delete_recursive("/cust/app/customized/partner-com.duokan.reader");
delete_recursive("/data/app/partner-com.duokan.reader");
delete_recursive("/cust/app/customized/partner-com.duokan.reader");
delete_recursive("/data/app/partner-Ctrip");
delete_recursive("/cust/app/customized/partner-Ctrip");
delete_recursive("/data/app/partner-Dianping");
delete_recursive("/cust/app/customized/partner-Dianping");
delete_recursive("/data/app/partner-DkReader");
delete_recursive("/cust/app/customized/partner-DkReader");
delete_recursive("/data/app/partner-DkReaderHD");
delete_recursive("/cust/app/customized/partner-DkReaderHD");
delete_recursive("/data/app/partner-Fengxing");
delete_recursive("/cust/app/customized/partner-Fengxing");
delete_recursive("/data/app/partner-Kankan");
delete_recursive("/cust/app/customized/partner-Kankan");
delete_recursive("/data/app/partner-MeituanHD");
delete_recursive("/cust/app/customized/partner-MeituanHD");
delete_recursive("/data/app/partner-MiReader");
delete_recursive("/cust/app/customized/partner-MiReader");
delete_recursive("/data/app/partner-MiShop");
delete_recursive("/cust/app/customized/partner-MiShop");
delete_recursive("/data/app/partner-MiShop");
delete_recursive("/cust/app/customized/partner-MiShop");
delete_recursive("/data/app/partner-MiShopHD");
delete_recursive("/cust/app/customized/partner-MiShopHD");
delete_recursive("/data/app/partner-MiTalk");
delete_recursive("/cust/app/customized/partner-MiTalk");
delete_recursive("/data/app/partner-MiTalk");
delete_recursive("/cust/app/customized/partner-MiTalk");
delete_recursive("/data/app/partner-mOffice");
delete_recursive("/cust/app/customized/partner-mOffice");
delete_recursive("/data/app/partner-NetEaseNews");
delete_recursive("/cust/app/customized/partner-NetEaseNews");
delete_recursive("/data/app/partner-Qunar");
delete_recursive("/cust/app/customized/partner-Qunar");
delete_recursive("/data/app/partner-Qzone");
delete_recursive("/cust/app/customized/partner-Qzone");
delete_recursive("/data/app/partner-Tuniu");
delete_recursive("/cust/app/customized/partner-Tuniu");
delete_recursive("/data/app/partner-UPPayPluginEx");
delete_recursive("/cust/app/customized/partner-UPPayPluginEx");
delete_recursive("/data/app/partner-Weibo");
delete_recursive("/cust/app/customized/partner-Weibo");
delete_recursive("/data/app/partner-XiMaLaYa");
delete_recursive("/cust/app/customized/partner-XiMaLaYa");
delete_recursive("/data/app/partner-XiMaLaYa");
delete_recursive("/cust/app/customized/partner-XiMaLaYa");
delete_recursive("/data/app/partner-XunfeiSpeechService3");
delete_recursive("/cust/app/customized/partner-XunfeiSpeechService3");
delete_recursive("/data/app/partner-XunfeiSpeechService3");
delete_recursive("/cust/app/customized/partner-XunfeiSpeechService3");
delete_recursive("/data/app/partner-Yinxiang");
delete_recursive("/cust/app/customized/partner-Yinxiang");
delete_recursive("/data/app/partner-Zixun");
delete_recursive("/cust/app/customized/partner-Zixun");
delete_recursive("/data/app/partner-Zixun");
delete_recursive("/cust/app/customized/partner-Zixun");
delete_recursive("/data/app/partner-ZixunHD");
delete_recursive("/cust/app/customized/partner-ZixunHD");
delete_recursive("/data/app/recommended-3rd-cn.wps.moffice_eng");
delete_recursive("/cust/app/customized/recommended-3rd-cn.wps.moffice_eng");
delete_recursive("/data/app/recommended-3rd-com.cleanmaster.mguard_cn");
delete_recursive("/cust/app/customized/recommended-3rd-com.cleanmaster.mguard_cn");
delete_recursive("/data/app/recommended-3rd-com.immomo.momo");
delete_recursive("/cust/app/customized/recommended-3rd-com.immomo.momo");
delete_recursive("/data/app/recommended-3rd-com.qiyi.video");
delete_recursive("/cust/app/customized/recommended-3rd-com.qiyi.video");
delete_recursive("/data/app/recommended-3rd-com.sina.weibo");
delete_recursive("/cust/app/customized/recommended-3rd-com.sina.weibo");
delete_recursive("/data/app/recommended-3rd-com.ss.android.article.news");
delete_recursive("/cust/app/customized/recommended-3rd-com.ss.android.article.news");
delete_recursive("/data/app/recommended-3rd-com.tuan800.tao800");
delete_recursive("/cust/app/customized/recommended-3rd-com.tuan800.tao800");
delete_recursive("/data/app/sky_happymj");
delete_recursive("/cust/app/customized/sky_happymj");
delete_recursive("/data/app/sky_kupao");
delete_recursive("/cust/app/customized/sky_kupao");
delete_recursive("/data/app/sky_xxd");
delete_recursive("/cust/app/customized/sky_xxd");
delete_recursive("/data/app/Transfer");
delete_recursive("/cust/app/customized/Transfer");
delete_recursive("/data/app/VTalk");
delete_recursive("/cust/app/customized/VTalk");
delete_recursive("/data/app/WaliLive");
delete_recursive("/cust/app/customized/WaliLive");
delete("/data/miui/cdrom_install.iso");
delete("/data/miui/apps/vanward_applist");
delete("/data/miui/app/noncustomized/O2O.apk");
delete("/data/miui/app/vanward_applist");
delete_recursive("/data/miui/apps");
delete_recursive("/data/miui/cust");
delete_recursive("/data/cust");
delete_recursive("/data/miui/cust_variant");
delete_recursive("/data/miui/app/recommended");
unmount("/cust");
ui_print("Installing custom recovery");
ui_print("Flashing TWRP Touch recovery...");
package_extract_file("recovery/twrp.img", "/dev/block/bootdevice/by-name/recovery");
set_progress(1);
